<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sync Watch - Watch Together</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="room-info" id="roomInfo">Room: Loading...</div>
    <div class="header">
      <h1>Sync Watch</h1>
      <p class="subtitle">Watch videos together in sync</p>
    </div>

    <!-- Username Overlay -->
    <div id="usernameOverlay" class="username-overlay">
      <div class="username-box">
        <h3>Enter your name:</h3>
        <input id="usernameInput" placeholder="Your name..." />
        <button id="joinBtn">Join Room</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content hidden" id="mainContent">
      <!-- Video Section -->
      <div class="video-section">
        <div class="start-overlay" id="startOverlay">
          <div class="start-icon">â–¶</div>
          <h2>Ready to watch together?</h2>
          <p>Click start to begin watching</p>
          <button class="start-btn" id="startBtn">Start Watching</button>
        </div>
        <div id="videoContainer" class="hidden">
          <div id="video" class="video-player"></div>
          <div id="bufferStatus" style="color:orange;display:none;">Buffering...</div>
        </div>
      </div>

      <!-- Queue Section -->
      <div class="queue-section">
        <h3>Queue</h3>
        <ul id="queueList"></ul>
        <input id="queueInput" placeholder="Paste YouTube URL or ID..." />
        <button id="addQueueBtn">Add to Queue</button>
      </div>

      <!-- User List -->
      <div class="user-list-section">
        <h3>Users in Room</h3>
        <ul id="userList" class="user-list"></ul>
      </div>

      <!-- Chat Section -->
      <div class="chat-section">
        <h3>Live Chat ðŸ’¬</h3>
        <div id="messages" class="messages"></div>
        <div class="chat-input-container">
          <input id="chatInput" class="chat-input" placeholder="Type a message..." />
          <button id="sendChatBtn" class="send-btn">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
const socket = io()
const urlParams = new URLSearchParams(window.location.search)
const room = urlParams.get("room") || "room123"

let username = ""
let player, isRemote = false, pendingPlay = null, startClicked = false
let currentVideoId = null

document.getElementById("roomInfo").textContent = `Room: ${room}`

// Join Room
document.getElementById("joinBtn").addEventListener("click", () => {
  const inputName = document.getElementById("usernameInput").value.trim()
  username = inputName || "Guest"
  socket.emit("join", { room, username })
  document.getElementById("usernameOverlay").classList.add("hidden")
  document.getElementById("mainContent").classList.remove("hidden")
})

// Extract video ID
function extractVideoId(url) {
  const regex = /(?:v=|\/)([a-zA-Z0-9_-]{11})/
  const match = url.match(regex)
  return match ? match[1] : url
}

function onPlayerStateChange(event) {
  if (!player || !startClicked) return
  if (isRemote) return

  const time = player.getCurrentTime()
  if (event.data === YT.PlayerState.PLAYING)
    socket.emit("sync", { room, action: "play", time })
  else if (event.data === YT.PlayerState.PAUSED)
    socket.emit("sync", { room, action: "pause", time })
  else if (event.data === YT.PlayerState.ENDED)
    socket.emit("nextVideo", { room }) // auto next
}

// Room data
socket.on("roomData", ({ videoId, users, time, isPlaying }) => {
  currentVideoId = videoId
  renderUsers(users)
  if (player && startClicked) {
    player.loadVideoById(videoId, time || 0)
    if (isPlaying) player.playVideo()
    else player.pauseVideo()
  }
})

// Start watching
document.getElementById("startBtn").addEventListener("click", () => {
  if (startClicked) return
  startClicked = true
  document.getElementById("startOverlay").classList.add("hidden")
  document.getElementById("videoContainer").classList.remove("hidden")

  player = new YT.Player("video", {
    videoId: currentVideoId || "_zgjWHqVUKM",
    events: {
      onReady: () => socket.emit("requestSync", { room }),
      onStateChange: onPlayerStateChange,
    },
  })
})

// Sync state
socket.on("syncState", ({ videoId, time, isPlaying }) => {
  if (!player) return
  currentVideoId = videoId
  player.loadVideoById(videoId, time || 0)
  if (isPlaying) player.playVideo()
  else player.pauseVideo()
})

// Sync events
socket.on("sync", ({ action, time }) => {
  if (!player || !startClicked) return
  isRemote = true
  const drift = Math.abs(player.getCurrentTime() - time)

  if (action === "play") {
    if (drift > 0.3) player.seekTo(time, true)
    if (player.getPlayerState() !== YT.PlayerState.PLAYING) player.playVideo()
  } else if (action === "pause") {
    if (drift > 0.3) player.seekTo(time, true)
    if (player.getPlayerState() !== YT.PlayerState.PAUSED) player.pauseVideo()
  }

  setTimeout(() => { isRemote = false }, 100)
})

// Queue update
socket.on("queueUpdate", (queue) => {
  const list = document.getElementById("queueList")
  list.innerHTML = ""
  queue.forEach((item, i) => {
    const li = document.createElement("li")
    li.className = "queue-item"
    li.innerHTML = `
      <img src="${item.thumbnail}" alt="thumb" class="thumb"/>
      <div class="queue-text">
        <strong>${i + 1}. ${item.title}</strong>
        <small>${item.videoId}</small>
      </div>
    `
    li.addEventListener("click", () => {
      socket.emit("playFromQueue", { room, index: i })
    })
    list.appendChild(li)
  })
})

// Video change
socket.on("videoChange", ({ videoId, time, isPlaying }) => {
  currentVideoId = videoId
  if (!player || !startClicked) return
  isRemote = true
  player.loadVideoById(videoId, time || 0)
  if (isPlaying) player.playVideo()
  else player.pauseVideo()
  isRemote = false
})

// Add to Queue
document.getElementById("addQueueBtn").addEventListener("click", () => {
  const vid = extractVideoId(document.getElementById("queueInput").value.trim())
  if (!vid) return
  socket.emit("addToQueue", { room, videoId: vid })
  document.getElementById("queueInput").value = ""
})
document.getElementById("queueInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") document.getElementById("addQueueBtn").click()
})

// Chat
const messagesDiv = document.getElementById("messages")
function sendMessage() {
  const msg = document.getElementById("chatInput").value.trim()
  if (!msg) return
  appendMessage(msg, username || "You")
  socket.emit("chat", { room, message: msg, username })
  document.getElementById("chatInput").value = ""
}
document.getElementById("sendChatBtn").addEventListener("click", sendMessage)
document.getElementById("chatInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage()
})

socket.on("chat", ({ message, username: sender }) =>
  appendMessage(message, sender)
)

function appendMessage(text, sender) {
  const div = document.createElement("div")
  div.className = "message"
  if (sender === username) div.classList.add("own")
  else div.classList.add("friend")
  div.textContent = `${sender}: ${text}`
  messagesDiv.appendChild(div)
  messagesDiv.scrollTop = messagesDiv.scrollHeight
}

// User list
const userListEl = document.getElementById("userList")
socket.on("updateUsers", (users) => renderUsers(users))

function renderUsers(users) {
  userListEl.innerHTML = ""
  users.forEach((u) => {
    const li = document.createElement("li")
    li.textContent = u
    if (u === username) li.classList.add("self")
    userListEl.appendChild(li)
  })
}
</script>
</body>
</html>
